rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // users: Publicly readable for search/keys, but only you can write your own.
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth.uid == userId;
    }

    // keyVaults: The most secure. You can ONLY read or write your OWN vault.
    match /keyVaults/{userId} {
      allow read, update, create: if request.auth.uid == userId;
    }

    // chats: This block contains the critical fix.
    match /chats/{chatId} {

      // 'get' (reading a single doc) is allowed if:
      // 1. The doc doesn't exist (for our 'check-if-exists' query)
      // 2. The doc *does* exist AND you are a participant.
      allow get: if resource == null || (request.auth.uid in resource.data.users);

      // 'list' (querying) is allowed if:
      // 1. You are a participant in the chat.
      // Firestore will check this rule against every doc in your query's results.
      // Since our query is `where('users', 'array-contains', auth.uid)`,
      // this rule will always pass for the documents found.
      allow list: if request.auth.uid in resource.data.users;

      // 'create' is allowed if you are in the 'users' array of the new doc.
      allow create: if request.auth.uid in request.resource.data.users;
      
      // 'update' is allowed if you are in the 'users' array of the existing doc.
      allow update: if request.auth.uid in resource.data.users;

      // --- messages (subcollection) ---
      match /messages/{messageId} {
        
        // You can read messages if you are a participant in the parent chat.
        allow read: if request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.users;

        // You can create a message if you are a participant AND you are the sender.
        allow create: if (request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.users)
                       && (request.auth.uid == request.resource.data.senderId);
      }
    }
  }
}